import requests
from datetime import datetime
import pytz

# ê¸°ë³¸ ì„¤ì •
hours = [0, 3, 6, 9, 12, 15, 18, 21]
base_demand = [50, 48, 55, 70, 90, 88, 75, 60]
LCOE_solar, LCOE_wind, LCOE_nuclear, LCOE_storage = 40, 35, 50, 10
nuclear_output = 35
storage_capacity = 50
storage = 0

# PM2.5 ì˜í–¥ ê³„ì‚°
def calculate_pm25_impact(pm25):
    return max(0.5, 1 - 0.005 * (pm25 / 10))

weather_impact = {"ë§‘ìŒ": 1.0, "íë¦¼": 0.75, "ë¹„": 0.5}

# ì‹¤ì œ ë‚ ì”¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì˜¨ì–‘6ë™ ìœ„ë„/ê²½ë„)
def get_real_weather_data():
    try:
        lat, lon = 36.7581, 127.0178   # ì˜¨ì–‘6ë™ ì¢Œí‘œ
        timezone = "Asia/Seoul"
        weather_url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&hourly=temperature_2m,shortwave_radiation,windspeed_10m,weathercode&timezone={timezone}"
        response = requests.get(weather_url)
        data = response.json()
        weather_data = data["hourly"]

        now = datetime.now(pytz.timezone(timezone))
        index_map = {hour: None for hour in hours}
        for i, t in enumerate(weather_data["time"]):
            hour = int(t[-5:-3])
            if hour in index_map and index_map[hour] is None:
                index_map[hour] = i

        idx_list = [index_map[h] for h in hours]
 ì˜¨ë„ = [ë‚ ì”¨_ë°ì´í„° ["ì˜¨ë„_2m"]][i] (idx_listì—ì„œ iì˜ ê²½ìš°)
 solar_rad = [ë‚ ì”¨_ë°ì´í„° ["ë‹¨íŒŒ_radiation"][i] for idx_list]
 ë°”ëŒ = [ë‚ ì”¨_ë°ì´í„° ["í’ì†_10m"][i] (i] for idx_list]
 code_map = {0: "ë§‘ìŒ", 1: "íë¦¼", 2: "ë¹„", 3: "ëˆˆ", 45: "íë¦¼", 51: "ë¹„"}
 ë‚ ì”¨ = [code_map.get(ë‚ ì”¨_data["weathercode"][i", "ë§‘ìŒ") (idx_listì—ì„œ iì— ëŒ€í•´)
 pm25 = [30] * 8

 ë³µê·€ ì˜¨ë„, íƒœì–‘ì—´_ë¼ë“œ, ë°”ëŒ, ì˜¤í›„ 25, ë‚ ì”¨

 ì˜ˆì™¸: e:
 print("ë°ì´í„° ìˆ˜ì§‘ ì˜¤ë¥˜:", e)
 return [25]*8, [500]*8, [5]*8, [30]*8, ["ë§‘ìŒ"]*8

# ì‹œë‚˜ë¦¬ì˜¤ ì •ì˜
def get_scenario_data(ì´ë¦„):
 ì´ë¦„ == "ë§‘ì€ ë‚ "ì¸ ê²½ìš°:
 ë°˜í™˜ [25]*8, [ì‹œê°„ ë‚´ì— hê°€ 6 <= h <= 18ì¼ ê²½ìš° 800, hê°€ 0ì¼ ê²½ìš°], [4]*8, [20]*8, ["ë§‘ìŒ"]*8, base_demand
 ì—˜í”„ ì´ë¦„ == "í­í’ìš°":
 ë°˜í’ˆ [20]*8, [0]*8, [12]*8, [80]*8, ["ë¹„"]*8, ê¸°ë³¸_ìˆ˜ìš”
 elif name == "ì—ë„ˆì§€ ê³µê¸‰ ì·¨ì•½":
 ë°˜í™˜ [32]*8, [100]*8, [3.2]*8, [120]*8, ["íë¦¼"]*8, [base_demandì—ì„œ dì— ëŒ€í•œ int(d*1.4)]
 ì—˜í”„ ì´ë¦„ == "íë¦° ë‚ ":
 ë°˜í™˜ [18]*8, [ì‹œê°„ ë‚´ hì— ëŒ€í•´ 6 <= h <= 18ì¸ ê²½ìš° 300), [4]*8, [50]*8, ["íë¦¼"]*8, ê¸°ë³¸_ìˆ˜ìš”
 ì—˜í”„ ì´ë¦„ == "ëˆˆ ë‚´ë¦¬ëŠ” ë‚ ":
 ë°˜í™˜ [-2]*8, [ì‹œê°„ ë‹¨ìœ„ë¡œ hê°€ 6 <= h <= 18ì¼ ê²½ìš° 0], [7]*8, [30]*8, ["íë¦¼"]*8, [base_demandì—ì„œ dì˜ ê²½ìš° int(d*1.1)]]ì„ ë°˜í™˜í•©ë‹ˆë‹¤
 ê·¸ë ‡ì§€ ì•Šìœ¼ë©´:
 ë°˜í™˜ get_real_weather_data () + (base_demand,)

# ì¬ìƒì—ë„ˆì§€ ë°œì „ëŸ‰ ê³„ì‚°
def calculate_renewable_ì—ë„ˆì§€(temp, íƒœì–‘ì—´_ë¼ë“œ, ë°”ëŒ_ì†ë„, pm25, ë‚ ì”¨):
 íƒœì–‘ì—´, í’ë ¥ = [], []
 ë²”ìœ„ (8)ì˜ iì— ëŒ€í•´:
 ê¸°ë³¸ = max(0, (solar_rad[i] / 1000) * 50 * (1 - 0.005 * (temp[i] - 25))
 eff = ê³„ì‚°_pm25_impact(pm25[i] * weather_impact.get(weather[i], 1.0)
 íƒœì–‘ì—´.append(ë² ì´ìŠ¤ * eff)
 ë°”ëŒ.append(ë°”ëŒ_ì†ë„[i] < 3 ë˜ëŠ” ë°”ëŒ_ì†ë„[i] > 25ê°œì˜ ë‹¤ë¥¸ 30 * (ë°”ëŒ_ì†ë„[i] / 10) ** 3ì¸ ê²½ìš° 0)
 íƒœì–‘ì—´, ë°”ëŒì˜ ê·€í™˜

# ì—ë„ˆì§€ ë¯¹ìŠ¤ ìµœì í™”
def optimize_energy_mix(solar, ë°”ëŒ, ìˆ˜ìš”):
 ê¸€ë¡œë²Œ ìŠ¤í† ë¦¬ì§€
 ìµœì í™”_solar, ìµœì í™”_ë°”ëŒ, ìŠ¤í† ë¦¬ì§€_usage = [], [], []
 ì´ ë¹„ìš© = 0
 ë²”ìœ„ (8)ì˜ iì— ëŒ€í•´:
 í•„ìš” = ìˆ˜ìš” [i] - í•µ_ì¶œë ¥
 ì‚¬ìš© ê°€ëŠ¥í•œ = íƒœì–‘ì—´ [i] + ë°”ëŒ [i]
 ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° < í•„ìˆ˜:
 ì¤‘ê³  = min(ì €ì¥, í•„ìˆ˜ - ì‚¬ìš© ê°€ëŠ¥)
 ì €ì¥ì†Œ -= ì‚¬ìš©ë¨
 storage_usage.append(ì‚¬ìš©ë¨)
 ê·¸ë ‡ì§€ ì•Šìœ¼ë©´:
 ì‰ì—¬ = ì‚¬ìš© ê°€ëŠ¥ - í•„ìˆ˜
 ì €ì¥ì†Œ + ì‰ì—¬ <= ì €ì¥ì†Œ_ìš©ëŸ‰:
 ì €ì¥ì†Œ += ì‰ì—¬
 ê·¸ë ‡ì§€ ì•Šìœ¼ë©´:
 ì‰ì—¬ -= (ìŠ¤í† ë¦¬ì§€_ìš©ëŸ‰ - ìŠ¤í† ë¦¬ì§€)
 ì €ì¥ì†Œ = ì €ì¥ì†Œ_ìš©ëŸ‰
 ratio_s = solar[i] / ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° 0
 ratio_w = wind [i] / ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš° 0
 íƒœì–‘ì—´ [i] -= ì‰ì—¬ * ë¹„ìœ¨_s
            wind[i] -= surplus * ratio_w
            storage_usage.append(0)
        optimized_solar.append(solar[i])
        optimized_wind.append(wind[i])
        total_cost += (solar[i] * LCOE_solar) + (wind[i] * LCOE_wind) + (nuclear_output * LCOE_nuclear) + (storage_usage[i] * LCOE_storage)
    return optimized_solar, optimized_wind, total_cost

# ì‹¤í–‰
print("\nğŸŒ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”:")
scenarios = ["ë§‘ì€ ë‚ ", "í­í’ìš°", "ì—ë„ˆì§€ ê³µê¸‰ ì·¨ì•½", "íë¦° ë‚ ", "ëˆˆ ë‚´ë¦¬ëŠ” ë‚ "]
for idx, name in enumerate(scenarios, 1):
    print(f"{idx}. {name}")
print("ì…ë ¥: ì‚¬ìš©ì ì •ì˜")
choice = input("\nğŸ‘‰ ì„ íƒ (1~5/ì…ë ¥): ")

if choice in [str(i) for i in range(1, 6)]:
    temp, solar_rad, wind_spd, pm25, weather, demand = get_scenario_data(scenarios[int(choice)-1])
else:
    temp, solar_rad, wind_spd, pm25, weather = get_real_weather_data()
    demand = base_demand

solar_gen, wind_gen = calculate_renewable_energy(temp, solar_rad, wind_spd, pm25, weather)
solar_opt, wind_opt, cost_opt = optimize_energy_mix(solar_gen, wind_gen, demand)

# ê²°ê³¼ ì¶œë ¥
print("\nâš¡ ìµœì  ì—ë„ˆì§€ ì¡°í•© (3ì‹œê°„ ê°„ê²©) âš¡")
for i in range(8):
    total = solar_opt[i] + wind_opt[i] + nuclear_output
    print(f"{hours[i]:02d}ì‹œ - íƒœì–‘ê´‘: {solar_opt[i]:.1f}MW, í’ë ¥: {wind_opt[i]:.1f}MW, ì›ìë ¥: {nuclear_output:.1f}MW, ì´: {total:.1f}MW")

print(f"\nğŸ’° ì´ ë°œì „ ë¹„ìš©: {cost_opt:,.0f} ì›")

print("âœ… ê¸°ìƒì²­ API ë°ì´í„° í™•ì¸")
print("ğŸŒ¡ï¸ ê¸°ì˜¨:", temp)
print("â˜€ï¸ ì¼ì‚¬ëŸ‰:", solar_rad)
print("ğŸ’¨ í’ì†:", wind_spd)
print("ğŸŒ«ï¸ PM2.5:", pm25)
print("ğŸŒ¦ï¸ ë‚ ì”¨ ìƒíƒœ:", weather)
